## Install Screwdriver in Minikube with a Helm chart 

This repo helps install Screwdriver using a Helm chart. The original helm chart repo can be at https://github.com/screwdriver-cd/screwdriver-chart

## Prerequisites

- [Helm](https://github.com/helm/helm)
- [Minikube](https://minikube.sigs.k8s.io/docs/)

## Preparing Minikube 

After installing minikube, create a new instance and enable the ingress addon:

```bash
  minikube start --cpus=3 --memory=8092 --disk-size 40g -p cdcon
  minikube addons enable ingress -p cdcon
```

The command above will start a 'cdcon' minikube instance with what I consider are the minimum requirements
to run Screwdriver.

## Setup authentication

Set up an oauth application access in Github (settings -> Developper settings -> Oauth Apps)

- The homepage url should be set to:

```shell
    http://xxxx-cd.screwdriver.cd
```

- The authorization call back should be:
```bash
    http://xxxx-api.screwdriver.cd/v4/auth/login
```

In the command above, 'xxxx' refers to the environment value used in the values.yaml (e.g. test or prod). 
Make sure to copy down the credentials generated by GitHub as they will be used to:

- Login to Screwdriver 
- Connect Screwdriver to GitHub

## Generate credentials 

Populate the example-scm-settings.json file with the credentials obtained from GitHub OAuth 
as well as the values required by Screwdriver as per the reference: [github.com/screwdriver-cd/screwdriver/blob/master/config/custom-environment-variables.yaml](https://github.com/screwdriver-cd/screwdriver/blob/master/config/custom-environment-variables.yaml#L265)

Run `./generate_secrets.sh` to create a Kubernetes secrets file (`screwdriver-api-secrets.yaml`) that contains the encoded secrets needed to interact with K8s and GitHub. 
It uses a combination of the values in `example-scm-settings.json` file and the `screwdriver-api-secrets.tmpl` template.

At the time of this writing the generate_secrets script could cause the following issues:
- The randomly generated values are not escaped properly and thus may cause the script to fail. 
- The randomly generated values are supposed to be at least 32 characters long (a requirements for some services). However, sometimes the values are too short which causes the application to fail
Note that The script does not back up the current secret values, so each time the script is run the current values are lost. 
As such, backup the values manually before running the script if needed
Note: Make sure the ```jwtqueuesvcpublickey``` and the ```queue-jwtpublickey``` secrets are set to the same value, otherwise the api may not be able to communicate with the queue service.

## Set up the Screwdriver configuration

Configure the Values.yaml file with the desired configuration to run Screwdriver.
Note that this repo contains the values commonly used to run Screwdriver in Minikube for personal projects.
This document discusses some of the most important values that need to be configured.
For the purposes of this discussion, it is assumed that we are setting a test environment in the test-screwdriver K8s namespace.

```yaml
namespace: test-screwdriver
env: test
api.ecosystem.queue: http://my-screwdriver-queue-service   # Queue service address
api.ecosystem.store: http://my-screwdriver-store   # Store service address
queue.dind: true   # Enables docker in docker so that Docker images can be built in the Screwdriver jobs
queue.resources.cpu.[micro,low,high,turbo]:    # Cpu resources  requested by each pod used to run pipeline jobs. 
queue.resources.memory.[micro,low,high,turbo]:  # Memory resources requested by each pod used to run pipeline jobs
queue.ecosystem.api: http://my-screwdriver-api   # Api service address
queue.ecosystem.store: http://my-screwdriver-store   # Store service address
redis.cluster.enables: false  # set to true to enable multi-instance Redis. Leave as false for running a single instance 
postgresql.persistence.enabled: true  # Allows data to be persisted using Kubernetes persistent volume
postgresql.persistence.size: 20Gi  # Amount of space allocated to persistent storage
```

Notes:
- Be very conservative with ```queue.resources.cpu``` request values as there will be Screwdriver will instantiate multiple pods at each step of a job. If the resource request are too high, the pods will not get scheduled. The values in this repo's Values.yaml for low cpu are the most a 3 cpu Minikube cluster can handle with dind jobs enabled
- Running a single Redis instance is good in a resource constrained environments
- The api.ecosystem and queue.ecosystem URLs must be set as described above for proper inter-service communication

## Namespace

The chart assumes that Screwdriver will run in the ```test-screwdriver``` namespace. In other to use a different namespace, modify:
- The screwdriver-api-secrets.yaml file
- The screwdriver-store-secrets.yaml file
- The values.yaml file
- The screwdriver-namespace.yaml file
- The Helm command to install the chart (see next section)

## Deploy Screwdriver

- Ensure helm dependencies are updated :

```shell
    helm dependency update
```

- Create the namespace that will host Screwdriver:

```shell
    kubectl apply -f screwdriver-namespace.yaml
```

- Deploy the Screwdriver's secrets:

```shell
  kubectl apply -f screwdriver-api-secrets.yaml
```
- Deploy Screwdriver:

```shell
    helm install my-screwdriver . --namespace test-screwdriver 
```

- Check the installation by running the command below and ensure that eventually all pods are healthy:

```shell
`kubectl get pods -n test-screwdriver`
```

## Access Screwdriver

#### Set up the ingress

 - Get the assigned IP and port for the ingress:

```shell
  kubectl get ingress -n test-screwdriver
```
   

- Use the IP and port values and create three entries in the host's ```etc/host``` file for:

    - Frontend: `test-cd.screwdriver.cd`
    - API:  `test-api.screwdriver.cd`
    - Store:  `test-store.screwdriver.cd`

- Access application:
  
    http://test-cd.screwdriver.cd/

## Uninstalling the chart:

```shell

 helm uninstall my-screwdriver
 kubeclt delete -f screwdriver-namespace.yaml

```


